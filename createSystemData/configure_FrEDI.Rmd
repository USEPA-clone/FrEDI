---
title: "Configure R Tool Data"
author: "Industrial Economics, Inc."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmarkdown::html_document:
    theme: spacelab
    toc: true
    toc_float: true
---

<style>
/* Simplified version of Bootstrap's responsive table CSS */
.table-responsive {
    display: block;
    width: 100%;
    overflow-x: auto;
}

.table-responsive > table {
    width: 100%;
}
</style>


```{r knitr setup, include=FALSE}
### The following parameters declare the options for compiling the Markdown document.
knitr::opts_chunk$set(
  include = T,     ### Evaluate and depict outputs of code chunks in the compiled document
  echo    = T,     ### Echo the commands of the code chunks in the compiled document
  message = FALSE, ### Don't include command-line messages output from evaluating code chunks
  cache   = FALSE, ### Don't cache the evaluation of code chunks
  warning = FALSE,  ### Don't include warnings from evaluating code chunks
  table.format = "html" 
)
```

## Overview

The purpose of this package is to configure the R tool

Load packages 

```{r loadPackages}
### Packages
require(tidyverse)
require(openxlsx)
require(devtools)
```


Date of most recent version of the Excel configuration file:

```{r mostRecentDate}
mostRecentDate <- "20220215"
c_newSectors   <- c("Agriculture")
```



```{r declare paths}
### Set system paths
projectPath      <- getwd()
today            <- format(Sys.Date(), "%Y%m%d")
### Project configuration
configPath       <- projectPath %>% paste("config", sep="/")
configFiles      <- configPath %>% list.files(".R")
### Code path
codePath         <- projectPath %>% paste("R", sep="/")
codeNames        <- codePath %>% list.files(".R")
configLogPath    <- codePath %>% paste("configLog", sep="/")

### Names for archive and use versions
configFileName   <- "fredi_config"
configArchName   <- configLogPath %>% paste(configFileName, sep="/") %>% paste(today, sep="_") %>% paste0(".rda")
configUseName    <- codePath %>% paste(configFileName, sep="/") %>% paste0(".rda")

### Output path
dataOutPath      <- projectPath %>% paste("data", sep="/")
dataOutLog       <- dataOutPath %>% paste("dataLog", sep="/")
sysFileName      <- "sysdata"
sysArchName      <- dataOutLog %>% paste(sysFileName, sep="/") %>% paste(today, sep="_") %>% paste0(".rda")
excelFileName    <- mostRecentDate %>% paste("FrEDI_config.xlsx", sep="_")
sysUseName       <- dataOutPath %>% paste(sysFileName, sep="/") %>% paste0(".rda")

### Path to fredi project
projectParentDir <- projectPath %>% paste("..", sep="/")
projectParentDir %>% list.files
frediPath         <- find.package("FrEDI", lib.loc=projectParentDir)
```

### Configuration Files

Load all configuration functions

```{r load config}
### Load all functions
configFiles; for(i in configFiles){ source(paste(configPath, i, sep="/")) }
```


List configuration files

```{r}
configLogPath %>% list.files("rda")
```

Update archive:

```{r}
frediConfig(outPath = configArchName)
```

Confirm copy was saved:

```{r}
basename(configArchName) %in% (configLogPath %>% list.files("rda"))
```

<!-- If a copy was saved, overwrite the config file: -->

<!-- ```{r tempBinConfig} -->
<!-- # tempBinConfig(outPath = configUseName) -->
<!-- ``` -->

## Create Tool Configuration Data


Load configuration data

```{r load configuration file}
# load(configUseName)
```



Load all R functions and configuration files

```{r load config}
### Load all functions
codeNames; for(i in codeNames){ source(paste(codePath, i, sep="/")) }
```

Test system data

```{r test_systemData0}
### Uncomment following two lines to create and save data and check the outputs
time1           <- Sys.time()
test_systemData <- createSystemData(save=F, excelName = excelFileName, silent=T)
time2           <- Sys.time()
time_create     <- time2 - time1; time_create
```

Use the following code chunk to view/check outputs for the new sector (all data stored in a list called `test_systemData`)

```{r check outputs}
# (test_systemData$slrImpacts %>% filter(sector %in% c_newSectors)) %>% filter(!is.na(annual_impacts)) %>% nrow
# test_systemData$slrImpacts %>% names
# test_systemData$df_results0$sector_label %>% unique
```



If above works, overwrite previous config

```{r save and overwrite data}
### Uncomment following two lines to create and save data and check the outputs
time1           <- Sys.time()
test_systemData <- createSystemData(save=T, excelName = excelFileName, outPath = sysArchName)
test_systemData <- createSystemData(save=T, excelName = excelFileName, silent=T)
time2           <- Sys.time()
time_create     <- time2 - time1; time_create
```





## Update R Tool

**Manually update the sysdata.rdata file in the Rtool.**

After copying and pasting the system data to the Rtool, try detaching the package and then loading the package functions. 


Try the package: 167,184 rows

```{r df_defaults, message=T}
frediPath %>% paste("R", sep="/") %>% load_all
# df_defaults <- run_fredi()
# df_defaults <- run_fredi(aggLevels = "all")
df_defaults <- run_fredi(aggLevels = "none")
df_defaults %>% glimpse
# df_defaults2 <- df_defaults %>% aggregate_impacts(aggLevels="all")
# df_defaults$sector %>% unique
# df_defaults %>% dim
```


```{r}
frediPath %>% paste("R", sep="/") %>% load_all
df_defaults2 <- df_defaults %>% aggregate_impacts(aggLevels="all")
# df_defaults$sector %>% unique
# df_defaults %>% dim
```



Create plots



```{r plot types, fig.height=10, fig.width=16}
### Create only heatmaps
# frediPath %>% paste("R", sep="/") %>% load_all()
# defPlots <- df_defaults %>% get_plots(plotTypes="heatmaps")
defPlots <- df_defaults2 %>% get_plots(plotTypes="heatmaps")
defPlots$heatmaps$SLR
```

